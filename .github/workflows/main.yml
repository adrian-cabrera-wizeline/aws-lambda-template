name: "ðŸš€ Unified Delivery Pipeline"

on:
  push:
    branches: [ main ]

jobs:
  # ------------------------------------------------------------------
  # STAGE 1: FACTORY (Build, Tag, Scan, Upload)
  # ------------------------------------------------------------------
  factory:
    uses: my-org/sre-templates/.github/workflows/reusable-build-factory.yml@v1
    with:
      artifact_bucket: "my-org-artifacts"
      service_names_json: '["price-fetcher", "config-service"]'
    secrets: inherit # Passes SONAR_TOKEN, AWS_ROLE, etc.

  # ------------------------------------------------------------------
  # STAGE 2: AUTOMATIC TRAIN (Dev -> QA)
  # ------------------------------------------------------------------
  deploy-dev:
    needs: factory
    uses: my-org/sre-templates/.github/workflows/reusable-promote-train.yml@v1
    with:
      environment: dev
      version_tag: ${{ needs.factory.outputs.new_version }}
      artifact_bucket: "my-org-artifacts"
      service_names_json: '["price-fetcher", "config-service"]'
    secrets: inherit

  deploy-qa:
    needs: deploy-dev
    uses: my-org/sre-templates/.github/workflows/reusable-promote-train.yml@v1
    with:
      environment: qa
      version_tag: ${{ needs.factory.outputs.new_version }}
      artifact_bucket: "my-org-artifacts"
      service_names_json: '["price-fetcher", "config-service"]'
    secrets: inherit

  # ------------------------------------------------------------------
  # STAGE 3: GATED TRAIN (UAT -> Prod)
  # ------------------------------------------------------------------
  deploy-uat:
    needs: deploy-qa
    uses: my-org/sre-templates/.github/workflows/reusable-promote-train.yml@v1
    with:
      environment: uat # ðŸ›‘ GITHUB PAUSES HERE FOR QA LEAD
      version_tag: ${{ needs.factory.outputs.new_version }}
      artifact_bucket: "my-org-artifacts"
      service_names_json: '["price-fetcher", "config-service"]'
    secrets: inherit

  deploy-prod:
    needs: deploy-uat
    uses: my-org/sre-templates/.github/workflows/reusable-promote-train.yml@v1
    with:
      environment: prod # ðŸ›‘ GITHUB PAUSES HERE FOR MANAGER
      version_tag: ${{ needs.factory.outputs.new_version }}
      artifact_bucket: "my-org-artifacts"
      service_names_json: '["price-fetcher", "config-service"]'
    secrets: inherit